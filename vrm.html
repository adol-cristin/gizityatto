<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VRM Smartphone App</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.154.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2.0.2/lib/three-vrm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.rawgit.com/yeemachine/kalidokit/master/dist/kalidokit.itools.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: sans-serif; color: white; }
        #ui { position: absolute; top: 10px; left: 10px; z-index: 100; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; width: calc(100% - 50px); }
        #video { position: absolute; bottom: 10px; right: 10px; width: 100px; height: 75px; border: 2px solid white; z-index: 10; transform: scaleX(-1); border-radius: 8px; background: #000; }
        input, button { font-size: 16px; margin: 5px 0; padding: 8px; width: 100%; border-radius: 5px; border: none; }
        button { background: #007bff; color: white; font-weight: bold; }
        #status { font-size: 12px; color: #ffcc00; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="ui">
        <b>1. VRM選択</b>
        <input type="file" id="fileInput" accept=".vrm">
        <b>2. 開始</b>
        <button id="startBtn">カメラ・マイクを許可して開始</button>
        <div id="status">VRMを選択してから開始ボタンを押してください</div>
    </div>

    <video id="video" playsinline webkit-playsinline muted autoplay></video>
    <div id="canvas-container"></div>

    <script>
        let currentVrm = null;
        const videoElement = document.getElementById('video');
        const statusElement = document.getElementById('status');

        // --- Three.js セットアップ ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 0.1, 20);
        camera.position.set(0, 1.4, 1.3);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 1.0);
        light.position.set(1, 1, 1).normalize();
        scene.add(light, new THREE.AmbientLight(0xffffff, 0.6));

        // --- VRMファイルの読み込み ---
        const loader = new THREE.GLTFLoader();
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            statusElement.textContent = "モデル読み込み中...";
            const url = URL.createObjectURL(file);
            loader.load(url, (gltf) => {
                THREE.VRM.from(gltf).then((vrm) => {
                    if (currentVrm) scene.remove(currentVrm.scene);
                    currentVrm = vrm;
                    scene.add(vrm.scene);
                    vrm.scene.rotation.y = Math.PI;
                    statusElement.textContent = "VRM準備完了！カメラを起動してください";
                });
            }, undefined, (err) => alert("読み込みエラー: " + err));
        });

        // --- MediaPipe Face Mesh ---
        const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
        faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5 });
        faceMesh.onResults((results) => {
            if (!currentVrm || !results.multiFaceLandmarks[0]) return;
            const rig = Kalidokit.Face.solve(results.multiFaceLandmarks[0], { runtime: 'mediapipe', video: videoElement });
            
            // 顔の動き
            const head = currentVrm.humanoid.getRawBoneNode('head');
            if (head) {
                head.rotation.y = rig.head.y;
                head.rotation.x = rig.head.x;
                head.rotation.z = rig.head.z;
            }
            // リップシンク & まばたき
            const s = rig.mouth.shape;
            currentVrm.expressionManager.setValue('aa', s.A);
            currentVrm.expressionManager.setValue('ih', s.I);
            currentVrm.expressionManager.setValue('ou', s.U);
            currentVrm.expressionManager.setValue('ee', s.E);
            currentVrm.expressionManager.setValue('oh', s.O);
            currentVrm.expressionManager.setValue('blink', 1 - rig.eye.l);
        });

        // --- カメラ起動 ---
        document.getElementById('startBtn').addEventListener('click', async () => {
            statusElement.textContent = "カメラ起動を試みています...";
            try {
                const cameraTracker = new Camera(videoElement, {
                    onFrame: async () => { await faceMesh.send({image: videoElement}); },
                    width: 640, height: 480
                });
                await cameraTracker.start();
                statusElement.textContent = "トラッキング中...";
                document.getElementById('ui').style.background = "transparent"; // UIを透かす
            } catch (err) {
                alert("カメラの起動に失敗しました。HTTPS環境か確認してください: " + err);
                statusElement.textContent = "起動失敗";
            }
        });

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            if (currentVrm) currentVrm.update(clock.getDelta());
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>

